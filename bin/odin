#!/usr/bin/env node

var program = require("commander"),
    mkdirp = require("mkdirp"),
    os = require("os"),
    fs = require("fs"),
    
    pkg = require("../package.json"),
    
    version = pkg.version,
    eol = os.EOL,
    path;

program
    .version( version )
    .parse( process.argv );

path = program.args.shift() || ".";
    

(function createApplication( path ){
    emptyDirectory( path, function( empty ){
	if( empty || program.force ){
	    createGame( path );
	}
	else{
	    program.confirm("destination is not empty, continue?", function( ok ){
		if( ok ){
		    process.stdin.destroy();
		    createGame( path );
		}
		else{
		    abort("aborting");
		}
	    });
	}
    });
}( path ));
    
    
function index( path ){
    return [
	'require(',
	'    {',
	'        baseUrl: "'+ path +'/"',
	'    },',
	'    [',
	'        "odin",',
	'    ],',
	'    function( Odin ){',
	'        var game = new Odin.ClientGame({',
	'            host: "127.0.0.1",',
	'            port: 8080,',
	'            debug: true',
	'        });',
	'        ',
	'        game.on("init", function(){',
	'            // Game Code goes here',
	'        });',
	'        ',
	'        game.init();',
	'    }',
	');'
    ].join("\n");
}


function game( path ){
    return [
	'var requirejs = require("requirejs");',
	
	'requirejs(',
	'    {',
	'        baseUrl: "'+ path +'/",',
	'        nodeRequire: require',
	'    },',
	'    [',
	'        "odinserver"',
	'    ],',
	'    function( OdinServer ){',
	'       var game = new OdinServer.ServerGame({',
	'           name: "Game",',
	'           host: "127.0.0.1",',
	'           port: 8080,',
	'       });',
	'    }',
	');'
    ].join("\n");
}

    
function createGame( path ){
    console.log();
    process.on("exit", function(){
	console.log();
	console.log("	install dependencies:");
	console.log("		$ cd "+ path +"/ && npm install");
	console.log();
	console.log("	start game:");
	console.log("		$ node game");
	console.log();
    });
    
    mkdir( path, function(){
	mkdir( path +"/js", function(){
	    write( path +"/js/index.js", index( path ) );
	});
	mkdir( path +"/assets");
    });
    
    var pkg = {
	name: "game",
	version: "0.0.1",
	scripts: {
	    start: "node game.js"
	},
	dependencies: {
	    odin: "~"+ version
	}
    };
    
    write( path + "/package.json", JSON.stringify( pkg, null, 2 ) );
    write( path + "/game.js", game( path ) );
}
    
    
function emptyDirectory( path, fn ){
    fs.readdir( path, function( error, files ){
	if( error && "ENOENT" != error.code ){
	    throw error;
	}
	fn( !files || !files.length );
    });
}
    
    
function write( path, str ){
    fs.writeFile( path, str );
    console.log("creating file: "+ path );
}


function mkdir( path, fn ){
    mkdirp( path, 755, function( error ){
	if( error ){
	    throw error;
	}
	console.log("creating dir: "+ path );
	fn && fn();
    });
}


function abort( str ){
    console.error( str );
    process.exit(1);
}


module.exports = program;